---
layout: post
title: ODoH in the wild
author: ms
date: 2023-08-10
# categories: [DNS]
comments: false
tags: [dns, odoh]
pin: False
author:
---

# ODOH - Oblivious DNS Over HTTPS RFC 9230.

## 1. DNS Goals
1. Security and Response Integrity - This can be achieved by adding a layer of encryption.
2. Privacy - This can be achieved by adding a PROXY between Client and the DNS Server to forward the DNS Request and DNS Response.


| Ability                                      | DNS |DOH / DOT | ODOH |
|----------------------------------------------|:-----:|:----------:|:------:|
| DNS Request / Response is Encrypted          | NO  | NO       | YES  |
| DNS Server track the Client's DNS requests | NO  | NO       | YES  |
| DNS Transport is Encrypted                  | NO  | YES      | YES  |



## 2. ODOH RFC

### 2.1 Publication
- [RFC 9230](https://datatracker.ietf.org/doc/rfc9230/)
- [paper](pdf)

### 2.2 ODOH Overview

#### to do add pic

#### 2.2.1 ODOH Parameters

1. odohConfig from `dnsResolver` OR `hosting URL`
- dnsResolver `1.1.1.1`
- URL `https://odoh.cloudflare-dns.com/.well-known/odohconfigs`
2. domain to look up `www.cloudflare.com`
3. which type of ResourceRecord, for the domain `type AAAA` - `DNS_TYPE #28`
4. odoh Server endpoint or IP Address.
- endpoint `https://odoh.cloudflare-dns.com/dns-query`
- IP `162.159.62.1`

#### 2.2.2 ODOH Server


def setup_query_context(skR, key_id, Q_encrypted):
    enc_32 || ct_: = Q_encrypted
    context = SetupBaseR(enc, skR, "odoh query")
    return context

def decrypt_query_body(context, key_id, Q_encrypted):
    aad = 0x01 || len(key_id) || key_id()
    enc_32 || ct_: = Q_encrypted
    Q_plain, error = context.Open(aad, ct)
    return Q_plain, error

def derive_secrets(context, Q_plain, resp_nonce):
    secret = context.Export("odoh response", Nk)
    salt = Q_plain || len(resp_nonce) || resp_nonce
    prk = Extract(salt, secret)
    key = Expand(odoh_prk, "odoh key", Nk)
    nonce = Expand(odoh_prk, "odoh nonce", Nn)
    return key, nonce

def encrypt_response_body(R_plain, aead_key, aead_nonce, resp_nonce):
    aad = 0x02 || len(resp_nonce) || resp_nonce
    R_encrypted = Seal(aead_key, aead_nonce, aad, R_plain)
    return R_encrypted



#### 2.2.2 ODOH Client

|TAG | Activity            | Function                                                     | 
|---|---------------------|--------------------------------------------------------------|
|1. DNS SERVER| GEN HPKE-Key Pair | GENERATE HPKE-Key Pair for ASymmetric Cryptography 	         |
|2. CLIENT| FETCH odohConfigs | FETCH odohConfigs for tge DNS Server 	                     |
|CLIENT|2. PARSE odohConfigs | PARSE and DERIVE odohConfigs                                 |
|CLIENT|2. BUILD  ODOH QueryContext| BUILD QueryContext and ObliviousDNSMessage                                 |
|CLIENT|2. BUILD  ODOH ObliviousDNSMessage| BUILD QueryContext and ObliviousDNSMessage                                 |
|CLIENT|3. Build ODOH Query  | CONSTRUCT an Encrypted DNS Query from odohConfig             |
|CLIENT|4. Send ODoH Query   | SEND the Encrypted DNS Query over HTTPS to the DNS Server    |
|SERVER|5. Parse Response    | PARSE ODoH response using the HPKE-Context  |

#### 2.2.1 ODOH Configs

ODOH Config is a bundle info about the HPKE Suite the DNS Server is capable of communicating in.
ODOH Configs is a list of ODOH Config. The Structure of odoh configs is,

```
   struct {
      uint16 kem_id;
      uint16 kdf_id;
      uint16 aead_id;
      opaque public_key<1..2^16-1>;
   } ObliviousDoHConfigContents;

   struct {
      uint16 version;
      uint16 length;
      select (ObliviousDoHConfig.version) {
         case 0x0001: ObliviousDoHConfigContents contents;
      }
   } ObliviousDoHConfig;
```






































