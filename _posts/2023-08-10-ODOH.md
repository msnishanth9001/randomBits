---
layout: post
title: ODoH in the wild
author: ms
date: 2023-08-10
# categories: [DNS]
comments: false
tags: [dns, odoh]
pin: False
author:
---

# ODoH - Oblivious DNS Over HTTPS - RFC 9230.

## 1. DNS Goals
1. Security - Can be achieved with a layer of ENCRYPTION.
2. Integrity - Can be achieved with CHECKSUM.
2. Privacy - Can be achieved with a PROXY between Client and the DNS Server.


| Feature                                      | DNS | DOH | ODOH |
|----------------------------------------------|:---:|:---:|:----:|
| DNS Request / Response is Encrypted          | NO  | NO  | YES  |
| DNS Server track the Client's DNS requests   | NO  | NO  | YES  |
| DNS Transport is Encrypted                   | NO  | YES | YES  |

Note: DOH/ DOT/ DOQ all have same characteristic, except the transport layer is different.

## 2. ODoH Publication
- ARXIV [ODoH: A Practical Privacy Enhancement to DNS](https://arxiv.org/abs/2011.10121)
- Oblivious DNS over HTTPS: ODoH [RFC 9230](https://datatracker.ietf.org/doc/rfc9230/)

## 3. ODoH Overview

1. odohConfig from `dnsResolver` OR `hosting URL`
- dnsResolver `1.1.1.1`
- URL `https://odoh.cloudflare-dns.com/.well-known/odohconfigs`
2. domain to look up `www.cloudflare.com`
3. which type of ResourceRecord, for the domain `type AAAA` - `DNS_TYPE #28`
4. odoh Server endpoint or IP Address.
- endpoint `https://odoh.cloudflare-dns.com/dns-query`

describe the client request and dns response
- IP `162.159.62.1`

![Desktop View](/assets/img/odoh/odoh_light.png){: .light}
![Desktop View](/assets/img/odoh/odoh_dark.png){: .dark}


|           Activity            | Function                                                  | 
|----------------------------------|--------------------------------------------------------|
|1. `CLIENT` REQ odohConfigs | REQUEST odohConfigs from DNS Server.                     |
|2. `SERVER` SEND odohConfigs | SEND HPKE-SUITE and PUB-KEY as odohConfigs to CLIENT.                   |
|3. `CLIENT` Send ODoH Query   | SEND Encrypted DNS Query to ODOH-PROXY.     |
|4. `PROXY` FWD ODoH Query   | FORWARD Encrypted DNS Query to ODNS Server.    |
|5. `SERVER` SEND ODoH Response   | SEND Encrypted DNS Answer to ODOH-PROXY.    |
|6. `PROXY` FORWARD ODoH Query   |  FORWARD Encrypted DNS Answer to CLIENT.   |

## 4. ODoH Exchange 

## HTTP Request/ RESPONSE Example CLI/ SERV/ PROXY
## Message Format

## 5. ODoH Server Behavior

def setup_query_context(skR, key_id, Q_encrypted):
    enc_32 || ct_: = Q_encrypted
    context = SetupBaseR(enc, skR, "odoh query")
    return context

def decrypt_query_body(context, key_id, Q_encrypted):
    aad = 0x01 || len(key_id) || key_id()
    enc_32 || ct_: = Q_encrypted
    Q_plain, error = context.Open(aad, ct)
    return Q_plain, error

def derive_secrets(context, Q_plain, resp_nonce):
    secret = context.Export("odoh response", Nk)
    salt = Q_plain || len(resp_nonce) || resp_nonce
    prk = Extract(salt, secret)
    key = Expand(odoh_prk, "odoh key", Nk)
    nonce = Expand(odoh_prk, "odoh nonce", Nn)
    return key, nonce

def encrypt_response_body(R_plain, aead_key, aead_nonce, resp_nonce):
    aad = 0x02 || len(resp_nonce) || resp_nonce
    R_encrypted = Seal(aead_key, aead_nonce, aad, R_plain)
    return R_encrypted

## 6. ODoH Client Behavior

def setup_query_context(skR, key_id, Q_encrypted):
    enc_32 || ct_: = Q_encrypted
    context = SetupBaseR(enc, skR, "odoh query")
    return context

def decrypt_query_body(context, key_id, Q_encrypted):
    aad = 0x01 || len(key_id) || key_id()
    enc_32 || ct_: = Q_encrypted
    Q_plain, error = context.Open(aad, ct)
    return Q_plain, error

def derive_secrets(context, Q_plain, resp_nonce):
    secret = context.Export("odoh response", Nk)
    salt = Q_plain || len(resp_nonce) || resp_nonce
    prk = Extract(salt, secret)
    key = Expand(odoh_prk, "odoh key", Nk)
    nonce = Expand(odoh_prk, "odoh nonce", Nn)
    return key, nonce

def encrypt_response_body(R_plain, aead_key, aead_nonce, resp_nonce):
    aad = 0x02 || len(resp_nonce) || resp_nonce
    R_encrypted = Seal(aead_key, aead_nonce, aad, R_plain)
    return R_encrypted


## 7. ODoH Configs

ODOH Config is a bundle info about the HPKE Suite the DNS Server is capable of communicating in.
ODOH Configs is a list of ODOH Config. The Structure of odoh configs is,

```
   struct {
      uint16 kem_id;
      uint16 kdf_id;
      uint16 aead_id;
      opaque public_key<1..2^16-1>;
   } ObliviousDoHConfigContents;

   struct {
      uint16 version;
      uint16 length;
      select (ObliviousDoHConfig.version) {
         case 0x0001: ObliviousDoHConfigContents contents;
      }
   } ObliviousDoHConfig;
```






































